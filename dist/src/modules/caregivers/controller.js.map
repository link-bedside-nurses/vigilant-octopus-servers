{"version":3,"file":"controller.js","sourceRoot":"","sources":["../../../../src/modules/caregivers/controller.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/ban-ts-comment */\r\nimport { HTTPRequest } from '../../adapters/express-callback'\r\nimport { StatusCodes } from 'http-status-codes'\r\nimport { db } from '../../db'\r\nimport mongoose from 'mongoose'\r\nimport { Caregiver } from '../../db/schemas/Caregiver'\r\nimport { Exception } from '../../utils'\r\n\r\nexport function getAllCaregivers() {\r\n\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n\treturn async function ( _: HTTPRequest<object> ) {\r\n\t\tconst caregivers = await db.caregivers.find( {} ).sort( { createdAt: \"desc\" } )\r\n\r\n\t\treturn {\r\n\t\t\tstatusCode: StatusCodes.OK,\r\n\t\t\tbody: {\r\n\t\t\t\tdata: caregivers,\r\n\t\t\t\tmessage: 'caregivers Retrieved',\r\n\t\t\t},\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function getCaregiver() {\r\n\treturn async function (\r\n\t\trequest: HTTPRequest<{\r\n\t\t\tid: string\r\n\t\t}>,\r\n\t) {\r\n\t\tconst caregiver = await db.caregivers.findById( request.params.id )\r\n\r\n\t\tif ( !caregiver ) {\r\n\t\t\treturn {\r\n\t\t\t\tstatusCode: StatusCodes.NOT_FOUND,\r\n\t\t\t\tbody: {\r\n\t\t\t\t\tmessage: 'No caregiver Found',\r\n\t\t\t\t\tdata: null,\r\n\t\t\t\t},\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\tstatusCode: StatusCodes.OK,\r\n\t\t\tbody: {\r\n\t\t\t\tdata: caregiver,\r\n\t\t\t\tmessage: 'caregiver Retrieved',\r\n\t\t\t},\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function deleteCaregiver() {\r\n\treturn async function (\r\n\t\trequest: HTTPRequest<{\r\n\t\t\tid: string\r\n\t\t}>,\r\n\t) {\r\n\t\tconst caregiver = await db.caregivers.findByIdAndDelete( request.params.id )\r\n\r\n\t\tif ( !caregiver ) {\r\n\t\t\treturn {\r\n\t\t\t\tstatusCode: StatusCodes.NOT_FOUND,\r\n\t\t\t\tbody: {\r\n\t\t\t\t\tmessage: 'No caregiver Found',\r\n\t\t\t\t\tdata: null,\r\n\t\t\t\t},\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\tstatusCode: StatusCodes.OK,\r\n\t\t\tbody: {\r\n\t\t\t\tdata: caregiver,\r\n\t\t\t\tmessage: 'caregiver deleted',\r\n\t\t\t},\r\n\t\t}\r\n\t}\r\n}\r\n\r\ninterface UpdateBody {\r\n\tphone: string\r\n\tfirstName: string\r\n\tlastName: string\r\n\tnin: string\r\n\tmedicalLicenseNumber: string\r\n\tdescription: string\r\n\tplaceOfReception: string\r\n\tspeciality: string[]\r\n\tlanguages: string[]\r\n\taffiliations: string[]\r\n\texperience: 0\r\n\tservicesOffered: string[]\r\n\timgUrl: string\r\n}\r\n\r\nexport function updateCaregiver() {\r\n\treturn async function (\r\n\t\trequest: HTTPRequest<\r\n\t\t\t{\r\n\t\t\t\tid: string\r\n\t\t\t},\r\n\t\t\tUpdateBody\r\n\t\t>,\r\n\t) {\r\n\t\tconst caregiver = await db.caregivers.findByIdAndUpdate( request.params.id, { ...request.body }, { new: true } )\r\n\r\n\t\tif ( !caregiver ) {\r\n\t\t\treturn {\r\n\t\t\t\tstatusCode: StatusCodes.NOT_FOUND,\r\n\t\t\t\tbody: {\r\n\t\t\t\t\tmessage: 'No caregiver Found',\r\n\t\t\t\t\tdata: null,\r\n\t\t\t\t},\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\tstatusCode: StatusCodes.OK,\r\n\t\t\tbody: {\r\n\t\t\t\tdata: caregiver,\r\n\t\t\t\tmessage: 'caregiver updated',\r\n\t\t\t},\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function deactivateCaregiver() {\r\n\treturn async function (\r\n\t\trequest: HTTPRequest<\r\n\t\t\t{\r\n\t\t\t\tid: string\r\n\t\t\t},\r\n\t\t\tUpdateBody\r\n\t\t>,\r\n\t) {\r\n\t\tconst caregiver = await db.caregivers.findByIdAndUpdate(\r\n\t\t\trequest.params.id,\r\n\t\t\t{ $set: { isDeactivated: true } },\r\n\t\t\t{ new: true },\r\n\t\t)\r\n\r\n\t\tif ( !caregiver ) {\r\n\t\t\treturn {\r\n\t\t\t\tstatusCode: StatusCodes.NOT_FOUND,\r\n\t\t\t\tbody: {\r\n\t\t\t\t\tmessage: 'No caregiver Found',\r\n\t\t\t\t\tdata: null,\r\n\t\t\t\t},\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\tstatusCode: StatusCodes.OK,\r\n\t\t\tbody: {\r\n\t\t\t\tdata: caregiver,\r\n\t\t\t\tmessage: 'Account successfully deactivated',\r\n\t\t\t},\r\n\t\t}\r\n\t}\r\n}\r\n\r\n\r\nconst locationBasedSearch = async ( params: {\r\n\tlocation: { lat: number; lng: number };\r\n\tdistance?: number; // in kilometres\r\n\tcriteria?: string;\r\n} ) => {\r\n\tconsole.log( params );\r\n\tconst { location: coords, distance: radiusInKm = 8.8 } = params;\r\n\r\n\t// validating search criteria query option\r\n\r\n\t// get location coords\r\n\tconst searchRadius = radiusInKm / 1.60934 / 3963.2;\r\n\tconst longitude = coords.lng;\r\n\tconst latitude = coords.lat;\r\n\r\n\t// query filter ...\r\n\tlet queryFilter: mongoose.FilterQuery<Caregiver> = {};\r\n\r\n\tqueryFilter = {\r\n\t\t...queryFilter,\r\n\t\tlocation: {\r\n\t\t\t$geoWithin: {\r\n\t\t\t\t$centerSphere: [[longitude, latitude], searchRadius],\r\n\t\t\t},\r\n\t\t},\r\n\t};\r\n\r\n\t// search through the database\r\n\tconst resultingCaregivers = await db.caregivers.find( {\r\n\t\t...queryFilter,\r\n\t} );\r\n\r\n\treturn resultingCaregivers;\r\n};\r\n\r\nexport function searchCaregiversByLocation() {\r\n\treturn async function (\r\n\t\treq: HTTPRequest<object, object,\r\n\t\t\t{\r\n\t\t\t\tlat: string; lng: string; distance: string\r\n\t\t\t}\r\n\t\t>,\r\n\t) {\r\n\t\tconst queryParams = req.query\r\n\r\n\t\tconsole.log( queryParams )\r\n\r\n\t\tif ( !queryParams.lat || !queryParams.lng ) {\r\n\t\t\tthrow new Exception( `Provide both 'lat' and 'lng' as query params` );\r\n\t\t}\r\n\t\tconst latitude: number = parseFloat( queryParams.lat );\r\n\t\tconst longitude: number = parseFloat( queryParams.lng );\r\n\r\n\t\t// filters\r\n\t\tlet filter: Partial<{ distance: number }> = {};\r\n\t\tif ( queryParams.distance ) {\r\n\t\t\tfilter = { ...filter, distance: parseFloat( queryParams.distance ) };\r\n\t\t}\r\n\r\n\t\tconst caregivers = await locationBasedSearch( { location: { lat: latitude, lng: longitude }, ...filter } );\r\n\r\n\t\treturn {\r\n\t\t\tstatusCode: StatusCodes.OK,\r\n\t\t\tbody: {\r\n\t\t\t\tdata: caregivers || [],\r\n\t\t\t\tmessage: caregivers.length > 0 ? `Found ${caregivers.length} result(s)` : \"No results found\",\r\n\t\t\t},\r\n\t\t}\r\n\t}\r\n}\r\n"]}